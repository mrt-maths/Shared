<script>
const OWNER  = "mrt-maths";
const REPO   = "Shared";
const BRANCH = "main";
const PATH   = "";

const statusEl = document.getElementById("status");
const gridEl = document.getElementById("games");
const qEl = document.getElementById("q");
const metaEl = document.getElementById("meta");

let allFiles = [];

function prettify(filename){
  return filename
    .replace(/\.html$/i,"")
    .replace(/[-_]+/g," ")
    .replace(/\b\w/g, c => c.toUpperCase());
}

function timeAgo(dateString){
  const diff = (Date.now() - new Date(dateString)) / 1000;

  if(diff < 60) return "just now";
  if(diff < 3600) return Math.floor(diff/60)+" mins ago";
  if(diff < 86400) return Math.floor(diff/3600)+" hrs ago";
  if(diff < 604800) return Math.floor(diff/86400)+" days ago";

  return new Date(dateString).toLocaleDateString();
}

function render(list){
  if (!list.length){
    gridEl.innerHTML = "";
    statusEl.innerHTML = `<div class="error">No matching HTML files found.</div>`;
    metaEl.textContent = "";
    return;
  }

  statusEl.innerHTML = "";

  const base = PATH ? (PATH.replace(/\/+$/,"") + "/") : "";

  gridEl.innerHTML = list.map(file => `
    <a class="card" href="${base}${encodeURI(file.name)}">
      <div class="title">${prettify(file.name)}</div>
      <div class="desc">
        Updated ${timeAgo(file.updated)}
      </div>
    </a>
  `).join("");

  metaEl.textContent = `${list.length} game(s)`;
}

async function getLastCommit(filename){
  const path = PATH ? `${PATH}/${filename}` : filename;

  const url = `https://api.github.com/repos/${OWNER}/${REPO}/commits?path=${encodeURIComponent(path)}&page=1&per_page=1`;

  const res = await fetch(url);

  if(!res.ok) return null;

  const data = await res.json();

  return data[0]?.commit?.committer?.date ?? null;
}

async function load(){

  statusEl.innerHTML = `<div class="small">Loading games…</div>`;

  try{

    const api = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${BRANCH}`;

    const res = await fetch(api);

    const items = await res.json();

    const htmlFiles = items
      .filter(x => x.type === "file" && /\.html$/i.test(x.name))
      .filter(x => x.name.toLowerCase() !== "index.html");

    // Fetch commit dates in parallel
    const filesWithDates = await Promise.all(
      htmlFiles.map(async file => ({
        name: file.name,
        updated: await getLastCommit(file.name)
      }))
    );

    // Sort newest first
    filesWithDates.sort((a,b) =>
      new Date(b.updated) - new Date(a.updated)
    );

    allFiles = filesWithDates;

    render(allFiles);

  } catch(err){

    statusEl.innerHTML = `
      <div class="error">
      Couldn’t load games.<br>${err.message}
      </div>`;
  }
}

qEl.addEventListener("input", () => {

  const term = qEl.value.toLowerCase();

  const filtered = allFiles.filter(f =>
    f.name.toLowerCase().includes(term)
  );

  render(filtered);
});

document.getElementById("reload").addEventListener("click", load);

load();
</script>
